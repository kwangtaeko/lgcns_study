<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>STOCK Corp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
          crossorigin="anonymous"
    >
</head>
<body>
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="card shadow-sm border-0" style="max-width: 380px; width: 100%;">
            <div class="card-body p-4">
                <h3 class="text-center mb-4 fw-bold text-primary">
                    <i class="bi bi-person-circle"></i> 로그인
                </h3>

                <form id="loginForm">
                    <div class="mb-3">
                        <label for="id" class="form-label fw-semibold">아이디</label>
                        <input type="text" id="id" name="id" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label fw-semibold">비밀번호</label>
                        <input type="password" id="password" name="password" class="form-control" required />
                    </div>

                    {{#error}}
                        <div class="alert alert-danger text-center py-2">{{error}}</div>
                    {{/error}}

                    <button type="submit" class="btn btn-primary w-100 fw-semibold mt-3">
                        로그인
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script>
        // ✅ [추가된 로직] 페이지 로드 시 로그인 상태 유지 확인
        const existingToken = localStorage.getItem("jwtToken");

        if (existingToken) {
            // 실제로는 서버에 토큰 유효성 검사를 요청해야 합니다.
            // 여기서는 간단하게 토큰이 존재하면 로그인 상태로 간주하고 리디렉션합니다.
            console.log("로컬 스토리지에 JWT 토큰이 존재합니다. 로그인 상태를 유지합니다.");
            alert("로그인 상태가 유지됩니다. 메인 페이지로 이동합니다.");

            // 메인 페이지(혹은 토큰이 필요한 다른 페이지)로 이동
            window.location.href = "/stock/getStock";

            // 토큰이 있으므로 폼 제출 로직은 무시됩니다.
        } else {
            console.log("로컬 스토리지에 JWT 토큰이 없습니다. 로그인이 필요합니다.");
        }

        document.getElementById("loginForm").addEventListener("submit", async (e) => {
          e.preventDefault();

         const response = await fetch("/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: document.getElementById("id").value,
                    password: document.getElementById("password").value
                })
            });

            if (response.ok) { // ⭐️ response.ok가 true일 때만 (HTTP 200번대)
                const token = await response.text();
                console.log("JWT 토큰:", token);

                localStorage.setItem("jwtToken", token);
                alert("로그인 성공! 토큰이 localStorage에 저장되었습니다.");
                window.location.href = "/stock/getStock"; // 성공 시 리디렉션 추가

            } else { // ⭐️ response.ok가 false일 때 (HTTP 401 등)
                // 서버에서 보낸 에러 메시지를 얻으려면 다시 response.text()를 사용
                const errorMessage = await response.text();
                alert("로그인 실패! : " + errorMessage);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</body>
</html>

